// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS

enum UserRole {
  AdminSistem
  PICMutu
  PJRuangan
  KepalaUnitInstalasi
  Direktur
  SubKomitePeningkatanMutu
  SubKomiteKeselamatanPasien
  SubKomiteManajemenRisiko
}

enum IndicatorCategory {
  INM
  IMP_RS
  IMPU
  SPM
}

enum IndicatorFrequency {
  Harian
  Mingguan
  Bulanan
  Tahunan
}

enum CalculationMethod {
  percentage
  average
}

enum IndicatorProfileStatus {
  Draf
  MenungguPersetujuan
  Disetujui
  Ditolak
}

enum SubmittedIndicatorStatus {
  MenungguPersetujuan
  Diverifikasi
  Ditolak
}

enum IncidentType {
  KPC
  KNC
  KTC
  KTD
  Sentinel
}

enum IncidentSeverity {
  biru
  hijau
  kuning
  merah
}

enum IncidentStatus {
  Investigasi
  Selesai
}

enum RiskSource {
  LaporanInsiden
  Komplain
  SurveyRonde
  RapatBrainstorming
  Investigasi
  Litigasi
  ExternalRequirement
}

enum RiskCategory {
  Strategis
  Operasional
  Finansial
  Compliance
  Reputasi
  PelayananPasien
  BahayaFisik
  BahayaKimia
  BahayaBiologi
  BahayaErgonomi
  BahayaPsikososial
}

enum RiskLevel {
  Rendah
  Moderat
  Tinggi
  Ekstrem
}

enum RiskEvaluation {
  Mitigasi
  Transfer
  Diterima
  Dihindari
}

enum RiskStatus {
  Open
  InProgress
  Closed
}

// MODELS

model User {
  id                      String                 @id @default(cuid())
  name                    String
  email                   String                 @unique
  password                String
  role                    UserRole
  unit                    String?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  createdProfiles         IndicatorProfile[]     @relation("CreatedBy")
  submittedIndicators     SubmittedIndicator[]   @relation("SubmittedBy")
  assignedRisks           Risk[]                 @relation("AssignedTo")
  notifications           Notification[]         @relation("Recipient")
}

model IndicatorProfile {
  id                 String               @id @default(cuid())
  title              String
  purpose            String
  definition         String
  implication        String
  calculationMethod  CalculationMethod
  numerator          String
  denominator        String
  target             Float
  targetUnit         String // "%" or "menit"
  inclusionCriteria  String
  exclusionCriteria  String
  dataRecording      String
  unitRecap          String
  analysisReporting  String
  area               String
  pic                String
  status             IndicatorProfileStatus @default(Draf)
  rejectionReason    String?
  unit               String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  createdBy          User                 @relation("CreatedBy", fields: [createdById], references: [id])
  createdById        String
  submittedIndicators SubmittedIndicator[]
}

model SubmittedIndicator {
  id              String                   @id @default(cuid())
  name            String
  category        IndicatorCategory
  description     String
  unit            String
  frequency       IndicatorFrequency
  status          SubmittedIndicatorStatus @default(MenungguPersetujuan)
  submissionDate  DateTime                 @default(now())
  standard        Float
  standardUnit    String // "%" or "menit"
  rejectionReason String?
  profile         IndicatorProfile         @relation(fields: [profileId], references: [id])
  profileId       String
  submittedBy     User                     @relation("SubmittedBy", fields: [submittedById], references: [id])
  submittedById   String
  achievements    Indicator[]
}

model Indicator {
  id                String            @id @default(cuid())
  indicator         String
  category          IndicatorCategory
  unit              String
  period            DateTime
  frequency         IndicatorFrequency
  numerator         Float
  denominator       Float
  calculationMethod CalculationMethod
  standard          Float
  standardUnit      String
  analysisNotes     String?
  followUpPlan      String?
  ratio             Float
  status            String // "Memenuhi Standar", "Tidak Memenuhi Standar", "N/A"
  submission        SubmittedIndicator @relation(fields: [submissionId], references: [id])
  submissionId      String
  createdAt         DateTime          @default(now())
}

model Incident {
  id                    String            @id @default(cuid())
  date                  DateTime          @default(now())
  status                IncidentStatus    @default(Investigasi)
  patientName           String?
  medicalRecordNumber   String?
  careRoom              String?
  ageGroup              String?
  gender                String?
  payer                 String?
  entryDate             DateTime?
  entryTime             String?
  incidentDate          DateTime?
  incidentTime          String?
  chronology            String?
  type                  IncidentType
  incidentSubject       String?
  incidentLocation      String?
  incidentLocationOther String?
  relatedUnit           String?
  firstAction           String?
  firstActionBy         String?
  hasHappenedBefore     String?
  severity              IncidentSeverity
  patientImpact         String?
  analysisNotes         String?
  followUpPlan          String?
}

model Risk {
  id                    String        @id @default(cuid())
  createdAt             DateTime      @default(now())
  unit                  String
  source                RiskSource
  description           String
  cause                 String
  category              RiskCategory
  consequence           Int
  likelihood            Int
  cxl                   Int
  riskLevel             RiskLevel
  controllability       Int
  riskScore             Int
ajukan
  evaluation            RiskEvaluation
  actionPlan            String
  dueDate               DateTime?
  status                RiskStatus    @default(Open)
  residualConsequence   Int?
  residualLikelihood    Int?
  residualRiskScore     Int?
  residualRiskLevel     RiskLevel?
  reportNotes           String?
  pic                   User?         @relation("AssignedTo", fields: [picId], references: [id])
  picId                 String?
}

model SurveyResult {
  id                   String   @id @default(cuid())
  submissionDate       DateTime @default(now())
  unit                 String
  scores               Json
  totalScore           Float
  positivePercentage   Float
  neutralPercentage    Float
  negativePercentage   Float
  answers              Json
}

model Notification {
  id              String    @id @default(cuid())
  timestamp       DateTime  @default(now())
  title           String
  description     String
  isRead          Boolean   @default(false)
  link            String?
  recipientRole   UserRole?
  recipientUnit   String?
  recipient       User?     @relation("Recipient", fields: [recipientId], references: [id])
  recipientId     String?
}

model SystemLog {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  user      String
  action    String
  details   String
}
