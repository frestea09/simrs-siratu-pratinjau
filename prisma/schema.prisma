// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS to ensure data integrity

enum UserRole {
  AdminSistem
  PICMutu
  PJRuangan
  KepalaUnitInstalasi
  Direktur
  SubKomitePeningkatanMutu
  SubKomiteKeselamatanPasien
  SubKomiteManajemenRisiko
  PetugasPelaporan
}

enum IndicatorCategory {
  INM
  IMP_RS
  IMPU
  SPM
}

enum IndicatorFrequency {
  Harian
  Mingguan
  Bulanan
  Triwulan
  Tahunan
}

enum CalculationMethod {
  percentage
  average
}

enum StandardUnit {
  percent
  minute
}

enum ProfileStatus {
  Draf
  MenungguPersetujuan
  Disetujui
  Ditolak
}

enum SubmissionStatus {
  MenungguPersetujuan
  Diverifikasi
  Ditolak
}

enum IncidentType {
  KPC
  KNC
  KTC
  KTD
  Sentinel
}

enum IncidentSeverity {
  biru
  hijau
  kuning
  merah
}

enum IncidentStatus {
  Investigasi
  Selesai
}

enum RiskSource {
  LaporanInsiden
  Komplain
  SurveyRonde
  RapatBrainstorming
  Investigasi
  Litigasi
  ExternalRequirement
}

enum RiskCategory {
  Strategis
  Operasional
  Finansial
  Compliance
  Reputasi
  PelayananPasien
  BahayaFisik
  BahayaKimia
  BahayaBiologi
  BahayaErgonomi
  BahayaPsikososial
}

enum RiskEvaluation {
  Mitigasi
  Transfer
  Diterima
  Dihindari
}

enum RiskLevel {
  Rendah
  Moderat
  Tinggi
  Ekstrem
}

enum RiskStatus {
  Open
  InProgress
  Closed
}


// MODELS

model User {
  id                        String              @id @default(cuid())
  name                      String
  email                     String              @unique
  password                  String
  role                      UserRole
  unit                      String?
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  // Relations
  createdProfiles           IndicatorProfile[]  @relation("CreatedBy")
  submittedIndicators       SubmittedIndicator[] @relation("SubmittedBy")
  reportedIncidents         Incident[]          @relation("ReportedBy")
  analysedIncidents         Incident[]          @relation("AnalysedBy")
  createdRisks              Risk[]              @relation("CreatedBy")
  picForRisks               Risk[]              @relation("PicForRisk")
  submittedSurveys          SurveyResult[]      @relation("SubmittedBy")
  notifications             Notification[]      @relation("Recipient")
  createdNotifications      Notification[]      @relation("Creator")
}

model Unit {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model IndicatorProfile {
  id                String             @id @default(cuid())
  title             String             @unique
  purpose           String
  definition        String             @db.Text
  implication       String             @db.Text
  calculationMethod CalculationMethod
  numerator         String
  denominator       String
  target            Float
  targetUnit        StandardUnit
  inclusionCriteria String             @db.Text
  exclusionCriteria String             @db.Text
  dataRecording     String
  unitRecap         String
  analysisReporting String
  area              String
  pic               String
  status            ProfileStatus      @default(Draf)
  rejectionReason   String?
  unit              String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  // Relations
  authorId          String
  author            User               @relation("CreatedBy", fields: [authorId], references: [id])
  submittedIndicators SubmittedIndicator[]
}

model SubmittedIndicator {
  id             String             @id @default(cuid())
  name           String
  category       IndicatorCategory
  description    String             @db.Text
  unit           String
  frequency      IndicatorFrequency
  status         SubmissionStatus   @default(MenungguPersetujuan)
  submissionDate DateTime           @default(now())
  standard       Float
  standardUnit   StandardUnit
  rejectionReason String?
  // Relations
  profileId      String
  profile        IndicatorProfile   @relation(fields: [profileId], references: [id])
  submittedById  String
  submittedBy    User               @relation("SubmittedBy", fields: [submittedById], references: [id])
  achievements   Indicator[]
}

model Indicator {
  id                String             @id @default(cuid())
  period            DateTime           @db.Date
  numerator         Float
  denominator       Float
  ratio             Float
  status            String
  analysisNotes     String?            @db.Text
  followUpPlan      String?            @db.Text
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  // Relations
  submissionId      String
  submission        SubmittedIndicator @relation(fields: [submissionId], references: [id])

  @@unique([submissionId, period]) // Ensure one report per indicator per period
}

model Incident {
  id                    String            @id @default(cuid())
  reportDate            DateTime          @default(now())
  status                IncidentStatus    @default(Investigasi)
  patientName           String?
  medicalRecordNumber   String?
  careRoom              String?
  ageGroup              String?
  gender                String?
  payer                 String?
  entryDate             DateTime?
  entryTime             String?
  incidentDate          DateTime?
  incidentTime          String?
  chronology            String?           @db.Text
  type                  IncidentType
  incidentSubject       String?
  incidentLocation      String?
  incidentLocationOther String?
  relatedUnit           String?
  firstAction           String?           @db.Text
  firstActionBy         String?
  hasHappenedBefore     String?
  severity              IncidentSeverity
  patientImpact         String?
  analysisNotes         String?           @db.Text
  followUpPlan          String?           @db.Text
  // Relations
  reporterId            String?
  reporter              User?             @relation("ReportedBy", fields: [reporterId], references: [id])
  analystId             String?
  analyst               User?             @relation("AnalysedBy", fields: [analystId], references: [id])
}

model Risk {
  id                    String         @id @default(cuid())
  createdAt             DateTime       @default(now())
  unit                  String
  source                RiskSource
  description           String         @db.Text
  cause                 String         @db.Text
  category              RiskCategory
  consequence           Int
  likelihood            Int
  cxl                   Int
  riskLevel             RiskLevel
  controllability       Int
  riskScore             Int
  evaluation            RiskEvaluation
  actionPlan            String         @db.Text
  dueDate               DateTime?
  status                RiskStatus     @default(Open)
  residualConsequence   Int?
  residualLikelihood    Int?
  residualRiskScore     Int?
  residualRiskLevel     RiskLevel?
  reportNotes           String?        @db.Text
  updatedAt             DateTime       @updatedAt
  // Relations
  authorId              String
  author                User           @relation("CreatedBy", fields: [authorId], references: [id])
  picId                 String?
  pic                   User?          @relation("PicForRisk", fields: [picId], references: [id])
}

model SurveyResult {
  id                 String   @id @default(cuid())
  submissionDate     DateTime @default(now())
  unit               String
  totalScore         Float
  positivePercentage Float
  neutralPercentage  Float
  negativePercentage Float
  answersJson        Json
  // Relations
  submittedById      String? // Can be anonymous
  submittedBy        User?    @relation("SubmittedBy", fields: [submittedById], references: [id])
}

model Notification {
  id            String    @id @default(cuid())
  timestamp     DateTime  @default(now())
  title         String
  description   String
  isRead        Boolean   @default(false)
  link          String?
  // Relations
  creatorId     String? // For system-generated, might be null
  creator       User?     @relation("Creator", fields: [creatorId], references: [id])
  recipientId   String
  recipient     User      @relation("Recipient", fields: [recipientId], references: [id])
}

model SystemLog {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  user      String
  action    String
  details   String   @db.Text
}
